// NanoBanana K-6 AI Learning Platform - Database Schema
// Prisma Schema for PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & USERS
// ============================================

model Parent {
  id               String   @id @default(uuid())
  email            String   @unique
  passwordHash     String
  firstName        String?
  lastName         String?
  phone            String?
  country          String   @default("AE")
  timezone         String   @default("Asia/Dubai")

  // Email verification
  emailVerified    Boolean  @default(false)
  emailVerifiedAt  DateTime?

  // KBQ Security Answers (hashed for verification)
  kbqAnswers       Json?    // Hashed answers: { questionId: hashedAnswer }

  // Consent tracking
  consents         Consent[]

  // Subscription
  subscriptionTier      SubscriptionTier   @default(FREE)
  subscriptionStatus    SubscriptionStatus @default(ACTIVE)
  stripeCustomerId      String?
  stripeSubscriptionId  String?            // Active Stripe subscription ID
  subscriptionExpiresAt DateTime?
  trialEndsAt           DateTime?          // Trial period end date

  // Relationships
  children         Child[]
  noteComments     NoteComment[]
  privacyPreferences ParentPrivacyPreferences?
  lessonUsage      ParentLessonUsage[]

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  lastLoginAt      DateTime?

  @@index([email])
}

model ParentPrivacyPreferences {
  id               String   @id @default(uuid())
  parentId         String   @unique
  parent           Parent   @relation(fields: [parentId], references: [id], onDelete: Cascade)

  // Data Collection Preferences
  learningAnalytics   Boolean  @default(true)  // Track progress, strengths, areas for improvement
  usageAnalytics      Boolean  @default(true)  // Help understand app usage
  personalization     Boolean  @default(true)  // Use data for personalized content

  // Data Sharing Preferences
  thirdPartyAnalytics Boolean  @default(false) // Share anonymized data with analytics providers
  improvementResearch Boolean  @default(false) // Contribute to educational research

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Child {
  id               String   @id @default(uuid())
  parentId         String
  parent           Parent   @relation(fields: [parentId], references: [id], onDelete: Cascade)

  // Profile
  displayName      String   // "Banana Explorer", etc. (no real name required)
  avatarUrl        String?
  pin              String   @db.Char(4) // 4-digit PIN for profile switching
  dateOfBirth      DateTime // For age calculation, never exposed
  ageGroup         AgeGroup // Calculated: YOUNG (4-7) or OLDER (8-12)

  // PIN Security (brute force protection)
  pinAttempts      Int      @default(0)  // Failed PIN attempts
  pinLockedUntil   DateTime?             // Lockout time if too many failures

  // Learning preferences
  gradeLevel       Int?     // 1-6
  curriculumType   CurriculumType?
  preferredLanguage String  @default("en")
  learningStyle    LearningStyle?

  // Privacy settings
  voiceEnabled     Boolean  @default(true)
  avatarVisible    Boolean  @default(true)

  // Relationships
  lessons          Lesson[]
  chatMessages     ChatMessage[]
  flashcardDecks   FlashcardDeck[]
  progress         UserProgress?
  xpTransactions   XPTransaction[]
  earnedBadges     EarnedBadge[]
  streak           Streak?
  safetyLogs       SafetyLog[]
  textSelections   TextSelection[]
  exerciseAttempts ExerciseAttempt[]
  notes            Note[]

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  lastActiveAt     DateTime?

  @@index([parentId])
}

model Consent {
  id               String   @id @default(uuid())
  parentId         String
  parent           Parent   @relation(fields: [parentId], references: [id], onDelete: Cascade)

  // Verification method
  method           ConsentMethod
  status           ConsentStatus

  // Verification details (encrypted)
  verificationData Json?    // Encrypted transaction ID, etc.
  ipAddress        String?
  userAgent        String?

  // Timestamps
  consentGivenAt   DateTime?
  expiresAt        DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([parentId, status])
}

// Parent lesson usage tracking (for FREE tier limits)
model ParentLessonUsage {
  id               String   @id @default(uuid())
  parentId         String
  parent           Parent   @relation(fields: [parentId], references: [id], onDelete: Cascade)

  // Monthly tracking
  month            DateTime @db.Date  // First day of the month (for grouping)
  lessonsCreated   Int      @default(0)

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([parentId, month])
  @@index([parentId, month])
}

// ============================================
// LEARNING CONTENT
// ============================================

model Lesson {
  id               String   @id @default(uuid())
  childId          String
  child            Child    @relation(fields: [childId], references: [id], onDelete: Cascade)

  // Content metadata
  title            String
  summary          String?  @db.Text
  subject          Subject?
  gradeLevel       String?
  sourceType       SourceType

  // Original content reference
  originalFileUrl  String?  // R2 URL
  originalFileName String?
  originalFileSize Int?
  youtubeUrl       String?
  youtubeVideoId   String?

  // AI-processed content
  extractedText    String?  @db.Text
  formattedContent String?  @db.Text // HTML with embedded interactive exercise markers
  chapters         Json?    // Array of chapter objects
  keyConcepts      String[] // For chat context
  vocabulary       Json?    // Array of {term, definition, example}
  suggestedQuestions String[]

  // Processing status
  processingStatus ProcessingStatus @default(PENDING)
  processingError  String?
  aiConfidence     Float?   // 0-1 confidence score

  // Safety review
  safetyReviewed   Boolean  @default(false)
  safetyFlags      String[] // Any flagged content

  // Relationships
  chatMessages     ChatMessage[]
  flashcardDecks   FlashcardDeck[]
  quizzes          Quiz[]
  textSelections   TextSelection[]
  exercises        InteractiveExercise[]
  notes            Note[]

  // Progress
  percentComplete  Float    @default(0)
  lastAccessedAt   DateTime?
  timeSpentSeconds Int      @default(0)
  completedAt      DateTime? // Set when user clicks "lesson completed"

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([childId, createdAt])
  @@index([processingStatus])
  @@index([childId, completedAt])
}

model ChatMessage {
  id               String   @id @default(uuid())
  childId          String
  child            Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  lessonId         String?
  lesson           Lesson?  @relation(fields: [lessonId], references: [id], onDelete: SetNull)

  // Message content
  role             MessageRole
  content          String   @db.Text

  // AI metadata (for assistant messages)
  modelUsed        String?  // gemini-1.5-flash, etc.
  tokensUsed       Int?
  responseTimeMs   Int?

  // Safety tracking
  safetyRatings    Json?    // Gemini safety ratings
  wasFiltered      Boolean  @default(false)
  filterReason     String?

  // Voice integration
  audioUrl         String?  // TTS audio URL

  // Timestamps
  createdAt        DateTime @default(now())

  @@index([childId, createdAt])
  @@index([lessonId])
}

// ============================================
// FLASHCARDS & QUIZZES
// ============================================

model FlashcardDeck {
  id               String   @id @default(uuid())
  childId          String
  child            Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  lessonId         String?
  lesson           Lesson?  @relation(fields: [lessonId], references: [id], onDelete: SetNull)

  title            String
  description      String?
  subject          Subject?
  isAIGenerated    Boolean  @default(false)

  // Relationships
  flashcards       Flashcard[]

  // Progress
  masteryLevel     Float    @default(0) // 0-100%
  lastStudiedAt    DateTime?

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([childId])
}

model Flashcard {
  id               String   @id @default(uuid())
  deckId           String
  deck             FlashcardDeck @relation(fields: [deckId], references: [id], onDelete: Cascade)

  front            String   @db.Text
  back             String   @db.Text
  imageUrl         String?
  audioUrl         String?  // TTS pronunciation

  // Spaced repetition (SM-2 algorithm)
  easeFactor       Float    @default(2.5)
  interval         Int      @default(1)  // Days
  repetitions      Int      @default(0)
  nextReviewAt     DateTime @default(now())

  // Statistics
  timesReviewed    Int      @default(0)
  timesCorrect     Int      @default(0)

  // Order
  orderIndex       Int      @default(0)

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([deckId, nextReviewAt])
}

model Quiz {
  id               String   @id @default(uuid())
  lessonId         String
  lesson           Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  title            String
  type             QuizType
  questions        Json     // Array of question objects

  // Attempts
  attempts         QuizAttempt[]

  // Timestamps
  createdAt        DateTime @default(now())

  @@index([lessonId])
}

model QuizAttempt {
  id               String   @id @default(uuid())
  quizId           String
  quiz             Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  answers          Json     // User's answers
  score            Float    // 0-100
  timeSpentSeconds Int

  // XP awarded
  xpEarned         Int      @default(0)

  // Timestamps
  completedAt      DateTime @default(now())

  @@index([quizId])
}

// ============================================
// GAMIFICATION
// ============================================

model UserProgress {
  id               String   @id @default(uuid())
  childId          String   @unique
  child            Child    @relation(fields: [childId], references: [id], onDelete: Cascade)

  // XP & Level
  currentXP        Int      @default(0)
  totalXP          Int      @default(0)
  level            Int      @default(1)

  // Subject-specific progress
  subjectProgress  Json?    // {math: {xp, level}, science: {xp, level}, ...}

  // Statistics
  lessonsCompleted Int      @default(0)
  questionsAnswered Int     @default(0)
  flashcardsReviewed Int    @default(0)
  perfectScores    Int      @default(0)
  totalStudyTimeSeconds Int @default(0)

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model XPTransaction {
  id               String   @id @default(uuid())
  childId          String
  child            Child    @relation(fields: [childId], references: [id], onDelete: Cascade)

  amount           Int
  reason           XPReason
  sourceType       String?  // "lesson", "flashcard", "quiz", etc.
  sourceId         String?  // ID of the source entity

  // Bonus info
  wasBonus         Boolean  @default(false)
  bonusMultiplier  Float?
  bonusReason      String?  // "streak_bonus", "first_of_day", etc.

  createdAt        DateTime @default(now())

  @@index([childId, createdAt])
}

model Streak {
  id               String   @id @default(uuid())
  childId          String   @unique
  child            Child    @relation(fields: [childId], references: [id], onDelete: Cascade)

  current          Int      @default(0)
  longest          Int      @default(0)
  lastActivityDate DateTime @db.Date
  freezeAvailable  Boolean  @default(false)
  freezeUsedAt     DateTime?

  updatedAt        DateTime @updatedAt
}

model Badge {
  id               String   @id @default(uuid())

  // Badge definition
  code             String   @unique // "first_lesson", "streak_7", etc.
  name             String
  description      String
  icon             String   // Emoji or icon name
  category         BadgeCategory
  rarity           BadgeRarity

  // Requirements
  requirements     Json     // Criteria for unlocking
  xpReward         Int      @default(0)

  // Earned instances
  earnedBy         EarnedBadge[]

  createdAt        DateTime @default(now())
}

model EarnedBadge {
  id               String   @id @default(uuid())
  childId          String
  child            Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  badgeId          String
  badge            Badge    @relation(fields: [badgeId], references: [id])

  earnedAt         DateTime @default(now())

  @@unique([childId, badgeId])
  @@index([childId])
}

model DailyChallenge {
  id               String   @id @default(uuid())

  date             DateTime @db.Date @unique
  type             ChallengeType
  target           Int
  description      String
  xpReward         Int

  // Completions
  completions      ChallengeCompletion[]

  createdAt        DateTime @default(now())

  @@index([date])
}

model ChallengeCompletion {
  id               String   @id @default(uuid())
  challengeId      String
  challenge        DailyChallenge @relation(fields: [challengeId], references: [id])
  childId          String

  progress         Int      @default(0)
  completed        Boolean  @default(false)
  completedAt      DateTime?

  @@unique([challengeId, childId])
}

// ============================================
// TEXT SELECTION & INTERACTIONS
// ============================================

model TextSelection {
  id               String   @id @default(uuid())
  childId          String
  child            Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  lessonId         String
  lesson           Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  selectedText     String   @db.Text
  beforeContext    String?  @db.Text
  afterContext     String?  @db.Text
  pageNumber       Int?

  actionType       SelectionAction
  userQuestion     String?
  resultData       Json     // Action-specific result

  xpAwarded        Int      @default(0)

  createdAt        DateTime @default(now())

  @@index([childId, createdAt])
  @@index([lessonId])
}

// ============================================
// NOTEBOOK & NOTES
// ============================================

model Note {
  id               String   @id @default(uuid())
  childId          String
  child            Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  lessonId         String?
  lesson           Lesson?  @relation(fields: [lessonId], references: [id], onDelete: SetNull)

  // Content
  title            String   @db.VarChar(255)
  content          String   @db.Text          // Rich text (HTML)
  originalText     String?  @db.Text          // Original highlighted text that started the note
  subject          Subject?
  contentFormat    NoteContentFormat @default(RICH_TEXT)

  // Personalization
  coverColor       String?  @default("#FFD93D")
  coverStickers    String[]                   // Array of sticker IDs selected by child
  coverPattern     String?  @default("dots")  // Pattern: dots, lines, stars, hearts, etc.

  // Organization
  isPinned         Boolean  @default(false)
  orderIndex       Int      @default(0)

  // Parent interaction
  parentComments   NoteComment[]

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([childId, subject])
  @@index([childId, lessonId])
  @@index([childId, isPinned, orderIndex])
}

model NoteComment {
  id               String   @id @default(uuid())
  noteId           String
  note             Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  parentId         String
  parent           Parent   @relation(fields: [parentId], references: [id], onDelete: Cascade)

  // Content
  content          String   @db.Text
  emoji            String?  // Optional emoji reaction

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([noteId, createdAt])
}

// ============================================
// INTERACTIVE EXERCISES
// ============================================

model InteractiveExercise {
  id               String   @id @default(uuid())
  lessonId         String
  lesson           Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  // Exercise identification
  type             ExerciseType
  orderIndex       Int      @default(0)

  // Content
  questionText     String   @db.Text        // "1/2 Ã— 1/4 = ___"
  contextText      String?  @db.Text        // Surrounding text for context
  originalPosition String?                   // Reference to position in source

  // Answer data
  expectedAnswer   String   @db.Text        // "1/8"
  acceptableAnswers String[]                 // ["0.125", "one eighth"]
  answerType       AnswerType @default(TEXT) // TEXT, NUMBER, SELECTION
  options          Json?                     // For multiple choice: ["Option A", "Option B", ...]

  // Hints and guidance
  hint1            String?  @db.Text        // First hint after wrong attempt
  hint2            String?  @db.Text        // Second hint
  explanation      String?  @db.Text        // Shown after correct/max attempts

  // Metadata
  difficulty       ExerciseDifficulty @default(MEDIUM)
  xpReward         Int      @default(10)

  // Relations
  attempts         ExerciseAttempt[]

  createdAt        DateTime @default(now())

  @@index([lessonId, orderIndex])
}

model ExerciseAttempt {
  id               String   @id @default(uuid())
  exerciseId       String
  exercise         InteractiveExercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  childId          String
  child            Child    @relation(fields: [childId], references: [id], onDelete: Cascade)

  submittedAnswer  String   @db.Text
  isCorrect        Boolean
  attemptNumber    Int      @default(1)
  aiFeedback       String?  @db.Text        // Jeffrey's personalized feedback
  xpAwarded        Int      @default(0)

  createdAt        DateTime @default(now())

  @@index([exerciseId, childId])
  @@index([childId, createdAt])
}

// ============================================
// SAFETY & MONITORING
// ============================================

model SafetyLog {
  id               String   @id @default(uuid())
  childId          String
  child            Child    @relation(fields: [childId], references: [id], onDelete: Cascade)

  incidentType     SafetyIncidentType
  severity         SafetySeverity

  // Context
  inputText        String?  @db.Text
  outputText       String?  @db.Text
  lessonId         String?

  // AI safety ratings
  geminiSafetyRatings Json?

  // Flags
  flags            String[]

  // Resolution
  wasBlocked       Boolean  @default(false)
  parentNotified   Boolean  @default(false)
  parentNotifiedAt DateTime?
  parentAction     String?  // "acknowledged", "restricted", etc.

  createdAt        DateTime @default(now())

  @@index([childId, createdAt])
  @@index([severity])
}

// ============================================
// TEACHER PORTAL - ORGANIZATIONS & TEACHERS
// ============================================

model Organization {
  id               String   @id @default(uuid())
  name             String
  slug             String   @unique  // For subdomain routing later
  type             OrganizationType

  // Billing & Subscription
  stripeCustomerId String?
  subscriptionTier OrgSubscriptionTier @default(STARTER)
  subscriptionStatus SubscriptionStatus @default(ACTIVE)

  // Token Quotas
  monthlyTokenQuota   BigInt   @default(1000000)  // 1M tokens/month starter
  currentMonthUsage   BigInt   @default(0)
  quotaResetDate      DateTime @default(now())

  // Relationships
  teachers         Teacher[]
  tokenUsageLogs   OrgTokenUsageLog[]

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([slug])
}

model Teacher {
  id               String   @id @default(uuid())
  email            String   @unique
  passwordHash     String
  firstName        String?
  lastName         String?

  // Email verification
  emailVerified    Boolean  @default(false)
  emailVerifiedAt  DateTime?

  // Organization (null for independent teachers)
  organizationId   String?
  organization     Organization? @relation(fields: [organizationId], references: [id])
  role             TeacherRole @default(TEACHER)

  // Individual subscription (when no org)
  subscriptionTier      TeacherSubscriptionTier @default(FREE)
  subscriptionStatus    SubscriptionStatus @default(ACTIVE)
  stripeCustomerId      String?
  stripeSubscriptionId  String?              // Active Stripe subscription ID
  subscriptionExpiresAt DateTime?

  // Trial period
  trialEndsAt           DateTime?            // When trial period ends (null = no trial)

  // Token Quotas (individual)
  monthlyTokenQuota     BigInt   @default(100000)  // 100K tokens/month free (100 credits)
  currentMonthUsage     BigInt   @default(0)
  quotaResetDate        DateTime @default(now())

  // Credit System (December 2025)
  rolledOverCredits     Int      @default(0)       // Credits rolled over from previous month
  bonusCredits          Int      @default(0)       // Credits from credit pack purchases (never expire)

  // Google Drive integration
  googleDriveTokens  Json?

  // Relationships
  content          TeacherContent[]
  rubrics          Rubric[]
  gradingJobs      GradingJob[]
  templates        ContentTemplate[]
  tokenUsageLogs   TokenUsageLog[]
  classrooms       Classroom[]

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  lastLoginAt      DateTime?

  @@index([email])
  @@index([organizationId])
}

// ============================================
// TEACHER PORTAL - TOKEN USAGE & QUOTAS
// ============================================

model TokenUsageLog {
  id               String   @id @default(uuid())
  teacherId        String
  teacher          Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  // Usage details
  operation        TokenOperation
  tokensUsed       Int
  modelUsed        String   // gemini-2.5-flash, gemini-3-pro, etc.

  // Context
  resourceType     String?  // "content", "grading", "quiz", etc.
  resourceId       String?

  // Cost tracking
  estimatedCost    Decimal? @db.Decimal(10, 6)  // USD

  createdAt        DateTime @default(now())

  @@index([teacherId, createdAt])
  @@index([operation])
}

model OrgTokenUsageLog {
  id               String   @id @default(uuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teacherId        String

  // Same fields as TokenUsageLog
  operation        TokenOperation
  tokensUsed       Int
  modelUsed        String
  resourceType     String?
  resourceId       String?
  estimatedCost    Decimal? @db.Decimal(10, 6)

  createdAt        DateTime @default(now())

  @@index([organizationId, createdAt])
  @@index([teacherId, createdAt])
}

// ============================================
// TEACHER PORTAL - CONTENT
// ============================================

model TeacherContent {
  id               String   @id @default(uuid())
  teacherId        String
  teacher          Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  // Content metadata
  title            String
  description      String?  @db.Text
  subject          Subject?
  gradeLevel       String?  // "K", "1", "2-3", "4-6", etc.
  contentType      TeacherContentType

  // Source material
  sourceType       SourceType?
  originalFileUrl  String?
  originalFileName String?
  extractedText    String?  @db.Text

  // Generated content (JSON structures)
  lessonContent    Json?    // Structured lesson with sections
  quizContent      Json?    // Quiz questions and answers
  flashcardContent Json?    // Flashcard deck
  infographicUrl   String?  // Generated infographic image

  // Publishing
  status           ContentStatus @default(DRAFT)
  isPublic         Boolean  @default(false)
  publishedAt      DateTime?

  // Template reference
  templateId       String?
  template         ContentTemplate? @relation(fields: [templateId], references: [id])

  // AI metadata
  tokensUsed       Int      @default(0)
  aiModelUsed      String?

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([teacherId, contentType])
  @@index([subject, gradeLevel])
  @@index([status])
}

model ContentTemplate {
  id               String   @id @default(uuid())
  teacherId        String
  teacher          Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  name             String
  description      String?
  contentType      TeacherContentType
  subject          Subject?
  gradeLevel       String?

  // Template structure
  structure        Json     // Sections, prompts, formatting rules
  defaultSettings  Json?    // Default AI parameters

  // Usage tracking
  usageCount       Int      @default(0)

  // Relationships
  content          TeacherContent[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([teacherId])
}

// ============================================
// TEACHER PORTAL - GRADING SYSTEM
// ============================================

model Rubric {
  id               String   @id @default(uuid())
  teacherId        String
  teacher          Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  name             String
  description      String?  @db.Text
  subject          Subject?
  gradeLevel       String?

  // Rubric structure
  criteria         Json     // Array of {name, description, weight, levels: [{score, label, description}]}
  maxScore         Int

  // Scoring config
  scoringType      ScoringType @default(POINTS)
  passingThreshold Float?   // Minimum passing score/percentage

  // AI grading config
  gradingPrompt    String?  @db.Text  // Custom prompt additions
  confidenceThreshold Float @default(0.7)  // Below this, flag for review

  // Usage
  usageCount       Int      @default(0)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  gradingJobs      GradingJob[]

  @@index([teacherId])
  @@index([subject])
}

model GradingJob {
  id               String   @id @default(uuid())
  teacherId        String
  teacher          Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  rubricId         String
  rubric           Rubric   @relation(fields: [rubricId], references: [id])

  // Job metadata
  name             String
  description      String?
  status           GradingJobStatus @default(PENDING)

  // Batch info
  totalSubmissions Int      @default(0)
  gradedCount      Int      @default(0)
  errorCount       Int      @default(0)

  // Processing
  startedAt        DateTime?
  completedAt      DateTime?
  processingError  String?

  // Token usage
  totalTokensUsed  Int      @default(0)

  // Relationships
  submissions      GradingSubmission[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([teacherId, status])
  @@index([rubricId])
}

model GradingSubmission {
  id               String   @id @default(uuid())
  gradingJobId     String
  gradingJob       GradingJob @relation(fields: [gradingJobId], references: [id], onDelete: Cascade)

  // Submission identification
  studentIdentifier String  // Anonymous ID or name (teacher choice)

  // Source
  fileUrl          String?
  fileName         String?
  extractedText    String?  @db.Text

  // AI Grading Results
  status           SubmissionStatus @default(PENDING)

  // Scoring (per criteria)
  criteriaScores   Json?    // {criterionId: {score, feedback, confidence}}
  totalScore       Float?
  percentageScore  Float?
  letterGrade      String?

  // AI Feedback
  overallFeedback  String?  @db.Text
  strengths        String[] // Key strengths identified
  improvements     String[] // Areas for improvement

  // Confidence & Review
  confidenceScore  Float?   // 0-1, AI's confidence in grading
  flaggedForReview Boolean  @default(false)
  flagReason       String?

  // Teacher Override
  teacherReviewed  Boolean  @default(false)
  teacherOverride  Json?    // {criterionId: {score, feedback}}
  teacherNotes     String?  @db.Text
  finalizedAt      DateTime?

  // Token usage
  tokensUsed       Int      @default(0)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([gradingJobId, status])
  @@index([flaggedForReview])
}

// ============================================
// TEACHER PORTAL - CLASSROOM (Future Integration)
// ============================================

model Classroom {
  id               String   @id @default(uuid())
  teacherId        String
  teacher          Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  name             String
  subject          Subject?
  gradeLevel       String?

  // Access code for students/parents
  accessCode       String   @unique
  isActive         Boolean  @default(true)

  // Future: Link to Child accounts via Parent consent
  // students         ClassroomStudent[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([teacherId])
  @@index([accessCode])
}

// ============================================
// ENUMS
// ============================================

enum SubscriptionTier {
  FREE
  FAMILY
  FAMILY_PLUS
  ANNUAL
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
}

enum AgeGroup {
  YOUNG  // 4-7
  OLDER  // 8-12
}

enum CurriculumType {
  BRITISH
  AMERICAN
  INDIAN_CBSE
  INDIAN_ICSE
  IB
  ARABIC
}

enum LearningStyle {
  VISUAL
  AUDITORY
  READING
  KINESTHETIC
}

enum ConsentMethod {
  CREDIT_CARD
  KBQ        // Knowledge-based questions
  MANUAL_REVIEW
}

enum ConsentStatus {
  PENDING
  VERIFIED
  FAILED
  EXPIRED
}

enum Subject {
  MATH
  SCIENCE
  ENGLISH
  ARABIC
  ISLAMIC_STUDIES
  SOCIAL_STUDIES
  ART
  MUSIC
  OTHER
}

enum SourceType {
  PDF
  IMAGE
  YOUTUBE
  TEXT
  CAMERA
  PPT
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum QuizType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  FILL_BLANK
  MATCHING
}

enum XPReason {
  LESSON_COMPLETE
  LESSON_PROGRESS
  FLASHCARD_REVIEW
  FLASHCARD_CORRECT
  QUIZ_COMPLETE
  QUIZ_PERFECT
  CHAT_QUESTION
  DAILY_CHALLENGE
  STREAK_BONUS
  BADGE_EARNED
  FIRST_OF_DAY
  TEXT_SELECTION
  EXERCISE_CORRECT
  EXERCISE_PERFECT
  NOTE_CREATED
  NOTE_EDITED
}

enum BadgeCategory {
  LEARNING
  STREAK
  MASTERY
  SOCIAL
  SPECIAL
}

enum BadgeRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

enum ChallengeType {
  LESSONS
  QUESTIONS
  FLASHCARDS
  TIME
  STREAK
}

enum SelectionAction {
  ASK
  FLASHCARD
  QUIZ
  SAVE
  READ
}

enum SafetyIncidentType {
  PROFANITY
  PII_DETECTED
  INAPPROPRIATE_TOPIC
  JAILBREAK_ATTEMPT
  HARMFUL_CONTENT
  BLOCKED_BY_GEMINI
  PARENT_OVERRIDE
}

enum SafetySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ExerciseType {
  FILL_IN_BLANK
  MATH_PROBLEM
  SHORT_ANSWER
  MULTIPLE_CHOICE
  TRUE_FALSE
}

enum AnswerType {
  TEXT
  NUMBER
  SELECTION
}

enum ExerciseDifficulty {
  EASY
  MEDIUM
  HARD
}

enum NoteContentFormat {
  PLAIN
  RICH_TEXT
}

// ============================================
// TEACHER PORTAL ENUMS
// ============================================

enum OrganizationType {
  SCHOOL
  DISTRICT
  TUTORING_CENTER
  HOMESCHOOL_COOP
  OTHER
}

enum OrgSubscriptionTier {
  STARTER      // 10 teachers, 1M tokens/month
  PROFESSIONAL // 50 teachers, 5M tokens/month
  ENTERPRISE   // Unlimited teachers, custom tokens
}

enum TeacherSubscriptionTier {
  FREE         // 100K tokens/month
  BASIC        // 500K tokens/month
  PROFESSIONAL // 2M tokens/month
}

enum TeacherRole {
  TEACHER
  DEPARTMENT_HEAD
  ADMIN
  SUPER_ADMIN
}

enum TeacherContentType {
  LESSON
  QUIZ
  FLASHCARD_DECK
  INFOGRAPHIC
  WORKSHEET
  STUDY_GUIDE
}

enum ContentStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

enum TokenOperation {
  CONTENT_ANALYSIS
  LESSON_GENERATION
  QUIZ_GENERATION
  FLASHCARD_GENERATION
  INFOGRAPHIC_GENERATION
  GRADING_SINGLE
  GRADING_BATCH
  FEEDBACK_GENERATION
  CHAT
}

enum ScoringType {
  POINTS
  PERCENTAGE
  LETTER_GRADE
  PASS_FAIL
}

enum GradingJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  PARTIALLY_COMPLETED
}

enum SubmissionStatus {
  PENDING
  PROCESSING
  GRADED
  FLAGGED
  REVIEWED
  FINALIZED
  ERROR
}
